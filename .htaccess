# Redirect HTTP to HTTPS
RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://www.taskproper.com/$1 [R=301,L]

# Redirect non-www to www
RewriteCond %{HTTP_HOST} ^taskproper\.com [NC]
RewriteRule ^(.*)$ https://www.taskproper.com/$1 [R=301,L]

# Redirect index.html to root
RewriteCond %{THE_REQUEST} /index\.html[\s?] [NC]
RewriteRule ^index\.html$ https://www.taskproper.com/ [R=301,L]

# ============================================
# 404 Error Prevention - Icon & Manifest Redirects
# ============================================

# Redirect old manifest icon references
RewriteCond %{REQUEST_URI} ^/web-app-manifest-192x192\.png$ [NC]
RewriteRule ^web-app-manifest-192x192\.png$ /android-chrome-192x192.png [L,R=301]

RewriteCond %{REQUEST_URI} ^/web-app-manifest-512x512\.png$ [NC]
RewriteRule ^web-app-manifest-512x512\.png$ /android-chrome-512x512.png [L,R=301]

# Redirect missing favicon variants (fallback)
RewriteCond %{REQUEST_URI} ^/favicon\.svg$ [NC]
RewriteCond %{DOCUMENT_ROOT}/favicon.svg !-f
RewriteRule ^favicon\.svg$ /favicon.ico [L,R=301]

# Fix 404 errors - Redirect old tool URLs to correct locations
RewriteRule ^tools/body-frame-inline\.html$ /health/body-frame-inline.html [R=301,L]
RewriteRule ^tools/seperate-tool/ivf-calculator\.html$ /health/ivf-calculator.html [R=301,L]
RewriteRule ^tools/cgpa-percentage-inline\.html$ /calculator/cgpa-percentage-inline.html [R=301,L]

# Force trailing slash removal for most pages except directories
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} /$
RewriteRule ^(.*)/$  https://www.taskproper.com/$1 [R=301,L]

# ========================================
# COMPREHENSIVE SECURITY CONFIGURATION
# ========================================

# Modern Security Headers (Updated for Best Practices)
<IfModule mod_headers.c>
    # HSTS - Force HTTPS for 2 years
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    
    # X-Content-Type-Options - Prevent MIME sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Referrer Policy - Protect user privacy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy - Restrict browser features
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()"
    
    # Content Security Policy with frame-ancestors (replaces X-Frame-Options)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://fonts.googleapis.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https://www.google-analytics.com; connect-src 'self' https://www.google-analytics.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self'"
    
    # Remove deprecated/unnecessary headers
    Header unset X-XSS-Protection
    Header unset X-Frame-Options
    Header unset Expires
    Header unset X-Powered-By
    Header unset Server
</IfModule>

# Prevent access to sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf|bak|backup|swp|tmp)$">
    Require all denied
</FilesMatch>

# Prevent access to hidden files and directories
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# Block suspicious request methods
<LimitExcept GET POST HEAD>
    Require all denied
</LimitExcept>

# Prevent hotlinking
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?taskproper\.com [NC]
RewriteRule \.(jpg|jpeg|png|gif|svg|webp|ico)$ - [F,L]

# Rate limiting for forms and API endpoints
<LocationMatch "/(contact|feedback)">
    <RequireAll>
        Require all granted
        # Add rate limiting rules here if mod_evasive is available
    </RequireAll>
</LocationMatch>

# Prevent directory browsing
Options -Indexes

# Disable server signature
ServerSignature Off

# ========================================
# PERFORMANCE & CACHING CONFIGURATION
# ========================================

# Modern Cache-Control Headers (replaces mod_expires)
<IfModule mod_headers.c>
    # Images - 1 year cache with immutable directive
    <FilesMatch "\.(jpg|jpeg|png|gif|svg|webp|ico|avif)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # CSS and JavaScript - 1 year cache with immutable directive
    <FilesMatch "\.(css|js)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # Fonts - 1 year cache with immutable directive & correct MIME type
    <FilesMatch "\.(woff|woff2|ttf|eot|otf)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>
    
    # HTML - Short cache for fresh content
    <FilesMatch "\.(html|htm)$">
        Header set Cache-Control "public, max-age=3600, must-revalidate"
    </FilesMatch>
    
    # JSON/Manifest files
    <FilesMatch "\.(json|webmanifest)$">
        Header set Cache-Control "public, max-age=86400"
    </FilesMatch>
    
    # XML files (sitemaps)
    <FilesMatch "\.xml$">
        Header set Cache-Control "public, max-age=86400"
    </FilesMatch>
</IfModule>

# Correct MIME Types for Web Fonts (fixes content-type issues)
<IfModule mod_mime.c>
    # Font types - WITHOUT charset (as per spec)
    AddType font/woff2 .woff2
    AddType font/woff .woff
    AddType font/ttf .ttf
    AddType font/otf .otf
    AddType application/vnd.ms-fontobject .eot
    
    # Remove charset from font responses
    <FilesMatch "\.(woff|woff2|ttf|otf|eot)$">
        Header unset Content-Type
    </FilesMatch>
    
    <FilesMatch "\.woff2$">
        Header set Content-Type "font/woff2"
    </FilesMatch>
    
    <FilesMatch "\.woff$">
        Header set Content-Type "font/woff"
    </FilesMatch>
    
    <FilesMatch "\.ttf$">
        Header set Content-Type "font/ttf"
    </FilesMatch>
    
    <FilesMatch "\.otf$">
        Header set Content-Type "font/otf"
    </FilesMatch>
    
    # Web App Manifest
    AddType application/manifest+json .webmanifest
    
    # Modern image formats
    AddType image/webp .webp
    AddType image/avif .avif
    AddType image/svg+xml .svg
</IfModule>

# Enable Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml application/manifest+json image/svg+xml
</IfModule>

# Enable ETags for cache validation
FileETag MTime Size

# Legacy mod_expires (backup for older servers) - Can be removed if Cache-Control works
<IfModule mod_expires.c>
    ExpiresActive Off
    # Disabled in favor of Cache-Control headers above
</IfModule>