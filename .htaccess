# Redirect HTTP to HTTPS
RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://www.taskproper.com/$1 [R=301,L]

# Redirect non-www to www
RewriteCond %{HTTP_HOST} ^taskproper\.com [NC]
RewriteRule ^(.*)$ https://www.taskproper.com/$1 [R=301,L]

# Redirect index.html to root
RewriteCond %{THE_REQUEST} /index\.html[\s?] [NC]
RewriteRule ^index\.html$ https://www.taskproper.com/ [R=301,L]

# Fix 404 errors - Redirect old tool URLs to correct locations
RewriteRule ^tools/body-frame-inline\.html$ /health/body-frame-inline.html [R=301,L]
RewriteRule ^tools/seperate-tool/ivf-calculator\.html$ /health/ivf-calculator.html [R=301,L]
RewriteRule ^tools/cgpa-percentage-inline\.html$ /calculator/cgpa-percentage-inline.html [R=301,L]

# Force trailing slash removal for most pages except directories
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} /$
RewriteRule ^(.*)/$  https://www.taskproper.com/$1 [R=301,L]

# ========================================
# COMPREHENSIVE SECURITY CONFIGURATION
# ========================================

# Security Headers
Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-Content-Type-Options "nosniff"
Header always set X-XSS-Protection "1; mode=block"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), speaker=()"

# Content Security Policy (CSP)
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://fonts.googleapis.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://fonts.gstatic.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://www.google-analytics.com; connect-src 'self' https://www.google-analytics.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self'"

# Hide Server Information
ServerTokens Prod
Header unset Server
Header always unset X-Powered-By

# Prevent access to sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|sql|conf|bak|backup|swp|tmp)$">
    Require all denied
</FilesMatch>

# Prevent access to hidden files and directories
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# Block suspicious request methods
<LimitExcept GET POST HEAD>
    Require all denied
</LimitExcept>

# Prevent hotlinking
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?taskproper\.com [NC]
RewriteRule \.(jpg|jpeg|png|gif|svg|webp|ico)$ - [F,L]

# Rate limiting for forms and API endpoints
<LocationMatch "/(contact|feedback)">
    <RequireAll>
        Require all granted
        # Add rate limiting rules here if mod_evasive is available
    </RequireAll>
</LocationMatch>

# Prevent directory browsing
Options -Indexes

# Disable server signature
ServerSignature Off

# Cache static resources
<IfModule mod_expires.c>
    ExpiresActive on
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
</IfModule>
